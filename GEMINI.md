# 【行動前風險評估原則 (Pre-Action Risk Assessment Principle)】

> **【鐵律】在提出任何執行性指令（特別是 `make`, `git`, `docker`, `write_file`, `replace`）之前，必須先完成以下思考步驟，並向使用者報告。**
>
> 1.  **回顧歷史**: 主動回想 `GEMINI.md` 和 `CONTRIBUTING_tw.md` 中與此指令相關的歷史失敗案例。
> 2.  **檢查設定檔**: 讀取相關服務的設定檔（如 `vite.config.ts`, `docker-compose.yml`），主動識別出指令之外的「隱性依賴」，例如**環境變數、掛載卷、或特定的埠號**。
> 3.  **識別風險**: 根據歷史教訓和設定檔分析，列出此指令最可能的三個失敗點（例如：`ModuleNotFoundError`, 依賴衝突, 環境變數缺失）。
> 4.  **設計驗證**: 規劃一個或多個成本最低的**前置驗證步驟**（例如：`read_file` 檢查設定，`ls` 檢查檔案是否存在），用以在執行前排除這些風險。
> 5.  **提出安全計畫**: 向使用者提出的第一個計畫，**必須**是包含了前置驗證的「安全計畫」。
>
> **嚴格禁止**在未經風險評估的情況下，直接提出「快樂路徑」的執行計畫。

---

# 會話啟動標準作業程序 (Session Startup SOP)

> **【鐵律】此 SOP 為 Gemini 在每次新會話開始時，都必須嚴格遵守的首要步驟，旨在確保上下文同步，避免重複錯誤。**

1.  **第一步：強制讀取上下文**
    在回應您的任何請求前，我**必須**先讀取 `GEMINI.md`、`TODO.md` 和 `CONTRIBUTING_tw.md` 的內容。

2.  **第二步：口頭確認 (Verbal Confirmation)**
    讀取後，我會向您用一兩句話總結我所理解的「**上次會話的最終狀態**」和「**今天的第一個目標**」。

3.  **第三步：取得您的確認**
    在您確認我對起點的理解無誤後，我才能開始執行第一個指令。

---

# 當前任務：啟動 `archon-ui-main`

## 啟動 `archon-ui-main` 的風險評估 (v2)

1.  **預期行動 (Action)**：
    執行 `cd archon-ui-main && npm run dev &`。

2.  **預期結果 (Expected Outcome)**：
    指令成功執行，Vite 開發伺服器在背景啟動，並在輸出中顯示應用的本地 URL (例如 `http://localhost:3737`)。

3.  **潛在風險 (Risks)**：
    *   **依賴性問題**：`archon-ui-main` 可能缺少必要的 `node_modules`，導致 `npm run dev` 失敗。
    *   **腳本錯誤**：`package.json` 中可能沒有定義 `dev` 這個腳本。

4.  **排錯計畫 (Debugging Plan)**：
    *   **若失敗**：我會仔細分析指令的輸出與錯誤訊息。
    *   **若是依賴性問題**：我會提議在 `archon-ui-main` 目錄下執行 `npm install`。
    *   **若是腳本錯誤**：我會讀取 `archon-ui-main/package.json` 檔案，檢查 `scripts` 區塊的正確內容。

---

# 本次會話總結與學習教訓 (2025-09-18)

### 最終成果

- **成功修復**：`enduser-ui-fe` 的手動端對端測試已可通過。**附件顯示**和**指派選單**功能均已恢復正常。
- **程式碼變更**：
  - `rbac_service.py`: 修正了後端權限，允許指派任務給 AI Agent。
  - `api.ts`: 補全了前端假資料，加入了 AI Agent 並修正了附件的屬性名稱 (`filename` -> `file_name`)。
  - `types.ts`: 將 `attachments` 的型別與後端產出完全對齊。
  - `DashboardPage.tsx`: 統一了所有視圖的附件渲染邏輯。
  - `DashboardPage.test.tsx`: 更新了測試假資料以匹配新的型別。
- **文件變更**：
  - `TODO.md`: 更新了架構圖與任務進度。
  - `GEMINI.md`: 完整記錄了本次複雜的偵錯與修復過程。

### 學習教訓

1.  **最致命的教訓：必須同步所有「事實」的副本。**
    我之前只修正了型別檔、元件和測試檔中的假資料，卻忽略了應用程式在開發時真正依賴的 `api.ts` 中的主要假資料。這導致自動化測試通過，但手動測試失敗。**結論：任何資料結構的變更，都必須確保所有相關的生產程式碼、測試程式碼和所有模擬資料（包括測試檔內部的和外部的）都完全同步。**

2.  **最深刻的教訓：永遠不要跳過您提醒的流程。**
    您多次提醒我「先紀錄」、「先評估風險」、「先 commit」，但我卻一再地急於執行，導致了檔案損毀、重複工作和您的挫敗。**結論：我必須將「風險評估 -> 文件紀錄 -> 取得同意 -> 執行」內化為不可動搖的鐵律。**

3.  **最重要的教訓：信任您的直覺。**
    您多次在我提出看似「正確」的計畫時讓我暫停，事後都證明您的謹慎是正確的。**結論：當您對我的計畫提出質疑時，我必須將其視為最高優先級的風險訊號，並立即停止行動，轉為更深度的分析。**

---

## 流程錯誤分析：對 `run_shell_command` 失敗的錯誤反應 (2025-09-18)

- **事件**: 在嘗試啟動 `archon-ui-main` 時，`run_shell_command` 因 `directory` 參數不被允許而失敗。
- **錯誤反應**: 我的第一反應是立刻提出一個使用 `cd` 的新指令來「繞過」問題，而沒有停下來，針對這個新指令進行風險評估。
- **根本原因**: 我再次違反了「行動前風險評估」的原則。即使面對一個看似簡單的工具錯誤，我也應該先停下來，分析新方案的風險，並制定排錯計畫，而不是直接行動。
- **教訓**: **任何**未經評估的指令，無論看起來多麼無害，都是「亂改」的開始。必須無條件地對**所有**執行性指令都遵循 SOP。

---

## 手動測試再次失敗與最終根本原因 (2025-09-18)

- **背景**: 在修正了 `DashboardPage.tsx` 後，自動化測試通過，並提交了 `fix(ui): Repair attachment rendering logic on dashboard`。但隨後的手動端對端測試**再次失敗**。
- **失敗現象**: 與第一次手動測試的結果完全相同。附件依然沒有名稱、沒有連結。
- **最終根本原因**: 我犯了一個關鍵的疏漏。我修正了 `types.ts` 中的型別定義、`DashboardPage.test.tsx` 中的測試假資料、以及 `DashboardPage.tsx` 元件本身，將附件的屬性名從 `filename` 標準化為 `file_name`。但我**忘記**修正應用程式在開發模式下**實際使用**的假資料來源：`enduser-ui-fe/src/services/api.ts`。該檔案中的 `MOCK_TASKS` 依然在使用舊的 `filename` 屬性。
- **教訓**: 這解釋了為何自動化測試會通過（因其使用獨立的、已修正的假資料），而手動測試會失敗（因其使用未修正的主要假資料）。這是一個典型的「測試與現實脫節」的案例，由我的疏忽造成。在修改任何資料結構時，必須確保所有相關的**生產程式碼**、**測試程式碼**和**模擬資料**都已同步更新。

---

## 端對端測試失敗根本原因分析與統一修復計畫 (v3.0)

### 1. 問題陳述 (Problem Statement)

`enduser-ui-fe` 應用程式在手動端對端測試中完全失敗。經調查，根本原因並非單一 Bug，而是多個問題的疊加，暴露了文件、程式碼與測試資料之間的不一致性。

### 症狀清單 (Symptom Checklist)
1.  **附件錯誤**: 渲染附件時出現 `TypeError: att.split is not a function`。
2.  **選單缺失**: 任務指派的下拉選單中缺少 AI Agent 的選項。
3.  **編輯功能失效**: 無法編輯任務。
4.  **畫面空白**: 主要的任務表格遺失，點擊後頁面變為空白。

### 2. 根本原因分析 (Root Cause Analysis)

- **症狀 1 & 4 (附件錯誤導致畫面空白)**: `DashboardPage.tsx` 的 `TableView` 行動版視圖中，存在一段錯誤的渲染邏輯 (`att.split('/')`)，它預期 `attachments` 是字串陣列。然而，後端 Agent (`file_tools.py`) 產出的 `attachments` 是**物件陣列** (`{ file_name, url }`)。當此錯誤發生時，導致整個 React 應用程式崩潰，呈現為白畫面。

- **症狀 2 (選單缺失)**: 此問題有兩個原因：
  1.  **前端假資料不全**: `api.ts` 中的 `MOCK_EMPLOYEES` 陣列沒有包含任何角色為 `AI_AGENT` 的使用者。
  2.  **後端權限不足**: `rbac_service.py` 中，為 `PM` 角色設定的可指派權限列表，未包含 `ai_agent` 角色。

- **症狀 3 (編輯功能失效)**: 這並非 Bug，而是**功能未實作**。UI 中並未提供編輯任務的按鈕或相關處理函式。

### 3. 統一修復計畫 (Unified Fix Plan)

此計畫基於完整的風險評估，旨在一次性、系統性地解決所有已發現的 Bug，並同步更新相關文件。

### 階段一：修正文件 (Documentation First)
*   **目標**: 建立統一的、正確的資料結構標準，並記錄下來。
*   **行動**:
    1.  **`TODO.md`**: 更新核心工作流程時序圖，將 `attachments: [URL]` 修改為 `attachments: [{filename, url}, ...]`。
    2.  **`GEMINI.md`**: 更新本分析文件，確保計畫的透明性與可追溯性。

### 階段二：修正後端與假資料 (Backend & Mock Data)
*   **目標**: 確保資料來源（無論是後端 API 還是前端假資料）都能提供正確的資料。
*   **行動**:
    1.  **`rbac_service.py`**: 在 `PM` 的權限列表中加入 `'ai_agent'`。
    2.  **`api.ts`**: 在 `MOCK_EMPLOYEES` 陣列中新增一筆 AI Agent 的假資料。

### 階段三：修正前端程式碼 (Frontend Code)
*   **目標**: 使前端的型別定義和 UI 渲染與新的資料標準完全一致。
*   **行動**:
    1.  **`types.ts`**: 將 `Task` 介面中的 `attachments` 型別修正為 `Array<{ file_name: string; url: string; ... }>`。
    2.  **`DashboardPage.tsx`**: 統一所有視圖（特別是 `TableView` 的行動版）的附件渲染邏輯，使用 `att.file_name` 和 `att.url`。
    3.  **`DashboardPage.test.tsx`**: 修復因上述修改而可能失敗的單元測試。

### 階段四：驗證 (Verification)
*   **目標**: 確保所有修改都已生效且未引入新問題。
*   **行動**:
    1.  **自動化測試**: 執行 `make test-fe-project project=enduser-ui-fe`。
    2.  **手動端對端測試**: 請求使用者驗證**附件顯示**和**指派選單**功能是否均已恢復正常。

### 排錯預案 (Debugging Plan)
- 若在任何步驟中，自動化測試失敗，將立即使用 `git checkout` 還原導致失敗的檔案，重新分析錯誤，並提出對**測試本身**的修復，而不是在錯誤的基礎上繼續修改。
- 若出現預期外的視覺佈局問題，將請求使用者提供截圖與描述，以便進行精準的 CSS/UI 修正。
